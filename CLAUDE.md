# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Проект: 3D Tetris

Это полнофункциональная 3D версия классического тетриса с вращением игрового поля и проекциями фигур на стены.

## Команды разработки

```bash
npm run dev     # Запуск dev-сервера на http://localhost:5173
npm run build   # Сборка проекта для продакшена
npm run preview # Предпросмотр собранной версии
```

## Архитектура

### Технологический стек
- **Three.js** - для 3D рендеринга
- **Reatom** - управление состоянием (реактивные атомы)
- **TypeScript** - строгая типизация
- **Vite** - сборка и dev-сервер

### Структура кода
Вся логика игры находится в `src/main.ts` (около 1800 строк). Основные компоненты:

1. **Игровые состояния**: MENU, PLAYING, PAUSED, GAME_OVER
2. **Игровое поле**: 10x10x18 блоков с визуальной сеткой
3. **Фигуры**: 7 классических тетромино в 3D формате
4. **Визуализация**: 
   - Основная сцена Three.js с освещением
   - Контейнеры для организации объектов (fieldContainer, wallsContainer, piecesContainer)
   - Система проекций на стены
   - Адаптивная прозрачность стен при вращении

### Управление
Управление адаптируется к текущему углу обзора игрового поля:
- **Стрелки** - движение фигуры
- **Q/W/E** - вращение фигуры по осям
- **A/D** - вращение поля
- **Space** - мгновенный сброс
- **S** - опустить на один уровень

### Ключевые функции
- `createPiece()` - создание 3D фигуры с материалом и геометрией
- `updateVisuals()` - обновление визуализации (позиция фигуры, проекции)
- `moveRelativeToView()` - адаптивное движение относительно угла обзора
- `checkCollision()` - проверка коллизий
- `clearLines()` - очистка заполненных линий
- `updateWallsOpacity()` - управление прозрачностью стен

### Реактивное состояние (Reatom)
Основные атомы:
- `gameStateAtom` - состояние игры
- `fieldAtom` - игровое поле (3D массив)
- `currentPieceAtom` - текущая фигура
- `scoreAtom` - счёт игры
- `rotationAtom` - угол вращения поля

## Особенности реализации

1. **Адаптивное управление**: движение фигур корректируется в зависимости от угла поворота игрового поля
2. **Проекции**: тени фигур отображаются на всех трёх стенах для лучшей ориентации в 3D
3. **Анимации**: плавное вращение поля, анимированное меню с падающими фигурами
4. **Визуальные эффекты**: bloom эффект, светящиеся элементы, полупрозрачные стены
5. **Система координат и камера**: 
   - Камера находится в позиции (0, 14, 14)
   - frontWallMesh: z = -5 (дальняя от камеры)
   - backWallMesh: z = +5 (ближайшая к камере)
   - При разных поворотах поля ближайшая грань меняется:
     * 0°: backWallMesh ближайшая
     * 90°: leftWallMesh ближайшая
     * 180°: frontWallMesh ближайшая  
     * 270°: rightWallMesh ближайшая

## Потенциальные улучшения при рефакторинге

При необходимости разделения кода рекомендуется структура:
- `game/logic.ts` - игровая логика
- `game/visuals.ts` - 3D визуализация
- `game/controls.ts` - управление
- `game/types.ts` - типы и интерфейсы
- `ui/menu.ts` - интерфейс меню
- `ui/hud.ts` - игровой интерфейс

## Memories

- всегда используй conport для получения большего контекста о проекте
- всегда используй conport для отслеживания задач, логирования принятых решений
- никогда не пытайся запустить проект, сервер всегда запущен
- всегда проверяй ошибки командой `npm run check`
